jQuery.fn.extend({pseudoSheet:function(a){a=jQuery.extend({error:function(c){this.val=c.error;return c.error;},dataHandler:{visible:function(c){if(c){this.$obj.show();}else{this.$obj.hide();}},enabled:function(c){if(c){this.$obj.removeAttr("disabled");}else{this.$obj.attr("disabled",true);}}},attrHandler:{visible:function(){return(this.$obj.is(":visible")?true:false);},enabled:function(){return(this.$obj.is(":enabled")?true:false);},value:function(){return b.objHandler.getObjectValue(this.$obj);}},formulaFunctions:{}},a);var b=jQuery.pseudoSheet.createInstance(this,a);b.calc();return this;}});jQuery.pseudoSheet={createInstance:function(c,b){var a=undefined,d={obj:c,calc:function(){d.calcLast=new Date();jPE.calc(d,d.updateObjectValue);},calcLast:0,callStack:0,fn:{OBJVAL:function(e){var f=[];jQuery(e).each(function(){d.updateObjectValue.apply(this);if(!isNaN(this.val)){this.val*=1;}f.push(this.val||"");});return(f.length>1?f:f[0]);}},updateObjectValue:function(){if(!this){return b.error.apply(this,[{error:"Object not found"}]);}var j=this,k=j.$obj=jQuery(this),g=k.is(":input");if(g){if(k.is(":radio,:checkbox")){if(k.is(":checked")){this.val=k.filter(":checked").val();}else{this.val="";}}else{this.val=k.val();}}else{this.val=k.html();}k.data("oldValue",this.val);if(this.state){return b.error.apply(this,[{error:"Loop Detected"}]);}this.state="updating";this.html=[];this.fnCount=0;this.calcCount=(this.calcCount||0);this.calcLast=(this.calcLast||0);if(this.calcLast!=d.calcLast){this.calcLast=d.calcLast;this.calcCount++;var f;if(d.callStack){if(!this.formulaParser){this.formulaParser=(new d.formulaParser);}f=this.formulaParser;}else{f=d.FormulaParser;}d.callStack++;f.lexer.obj=this;f.lexer.handler=d.objHandler;var h=k.data();jQuery.each(h,function(m){if(b.dataHandler[m]){var e=(h[m].charAt(0)=="="),l=(h[m].charAt(0)=="="?h[m].substring(1,h[m].length):h[m]),n=function(){var o={result:f.parse(l)};d.filterValue.apply(o);return o.val;};b.dataHandler[m].apply(j,[n()]);}});if(h.formula){try{if(h.formula.charAt(0)=="="){h.formula=h.formula.substring(1,h.formula.length);}this.result=f.parse(h.formula);}catch(i){console.log(i);j.val=i.toString().replace(/\n/g,"<br />");}d.callStack--;d.filterValue.apply(this);if(g){k.val(this.val);}else{k.html(this.result.html!==a?this.result.html:this.val);}}}j.state=null;return this.val;},filterValue:function(){if(this.result!==a){if(this.result.value!==a){this.val=this.result.value;this.html=this.result.html||this.result.value;}else{this.val=this.result;}}else{this.result={html:this.val};}},objHandler:{callFunction:function(k,g){g=g||[];if(d.fn[k]){this.fnCount++;var f=[],j=[],e,h=g.length;if(h){do{if(g[h]!=a){if(g[h].value||g[h].html){f.unshift(g[h].value);j.unshift(g[h].html);}else{f.unshift(g[h]);j.unshift(g[h]);}}}while(h--);}e=d.fn[k].apply(this,f);if(e!=null){if(e.html!=a){this.html.push(e.html);}else{this.html.push(null);}if(e.value!=a){return e.value;}}return e;}else{return b.error.apply(this,[{error:"Function Not Found"}]);}},variable:function(){var e=arguments;if(e.length==1){switch(e[0].toLowerCase()){case"true":return true;case"false":return false;}}var f=jQuery("#"+e[0]);if(!f.length){f=jQuery('[name="'+e[0]+'"]');}if(!f.length){return b.error.apply(this,[{error:"Object not found"}]);}if(e.length>1){if(b.attrHandler[e[1]]){return b.attrHandler[e[1]].apply({$obj:f,vars:e});}return b.error.apply(this,[{error:"Attribute not found"}]);}return d.objHandler.getObjectValue(f);},time:function(f,e){return times.fromString(f,e);},getObjectValue:function(e){if(e.is(":radio,:checkbox")){e=e.filter(":checked");}if(!e[0]){e[0]=jQuery("<div />");}return d.updateObjectValue.apply(e[0]);},concatenate:function(){return jFN.CONCATENATE.apply(this,arguments).value;}}};if(jQuery.sheet.fn){d.fn=jQuery.extend(jQuery.sheet.fn,d.fn);if(jQuery.sheet.advancedfn){d.fn=jQuery.extend(d.fn,jQuery.sheet.advancedfn);}if(jQuery.sheet.financefn){d.fn=jQuery.extend(d.fn,jQuery.sheet.financefn);}if(b.formulaFunctions){d.fn=jQuery.extend(d.fn,b.formulaFunctions);}}d.formulaLexer=function(){};d.formulaLexer.prototype=formula.lexer;d.formulaParser=function(){this.lexer=new d.formulaLexer();this.yy={};};d.formulaParser.prototype=formula;d.FormulaParser=new d.formulaParser;return d;}};var jPE=jQuery.pseudoSheetEngine={calc:function(c,b){for(var a=0;a<c.obj.length;a++){b.apply(c.obj[a]);}}};